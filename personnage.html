<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche Personnage - The Hope Heritage</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-logo">The Hope Heritage</div>
        <ul class="nav-links">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="histoire.html">Histoire</a></li>
            <li><a href="systeme.html">Système de jeu</a></li>
            <li><a href="personnage.html">Fiches personnage</a></li>
        </ul>
    </nav>

    <main class="content-section">
    <h1>Fiche de : <span id="displayID">...</span></h1>
    
    <div class="card">
        <h2 class="section-title">Informations générales</h2>
        <div class="grid-container">
            <div class="input-group"><label>Nom & Prénom</label><input type="text" id="nomComplet" class="save-field"></div>
            <div class="input-group"><label>Âge</label><input type="number" id="age" class="save-field"></div>
            <div class="input-group"><label>Faction</label><input type="text" id="faction" class="save-field"></div>
            <div class="input-group"><label>Pouvoir</label><input type="text" id="pouvoir" class="save-field"></div>
            <div class="input-group"><label>École de Combat</label><input type="text" id="ecoleCombat" class="save-field"></div>
            <div class="input-group"><label>Religion</label><input type="text" id="religion" class="save-field"></div>
        </div>

        <div class="grid-container">
            <section>
                <h2 class="section-title">Physique</h2>
                <div class="input-group"><label>Taille / Poids</label><input type="text" id="physique_tp" class="save-field"></div>
                <div class="input-group"><label>Yeux / Cheveux</label><input type="text" id="physique_yc" class="save-field"></div>
                <div class="input-group"><label>Style Vestimentaire</label><textarea id="styleVest" class="save-field"></textarea></div>
                <div class="input-group"><label>Traits Particuliers</label><textarea id="traitsPart" class="save-field"></textarea></div>
            </section>
            <section>
                <h2 class="section-title">Personnalité et Relations</h2>
                <div class="input-group"><label>Qualités</label><input type="text" id="qualites" class="save-field"></div>
                <div class="input-group"><label>Défauts</label><input type="text" id="defauts" class="save-field"></div>
                <div class="input-group"><label>Famille</label><textarea id="famille" class="save-field"></textarea></div>
                <div class="input-group"><label>Amis</label><textarea id="amis" class="save-field"></textarea></div>
            </section>
        </div>

        <h2 class="section-title">Caractéristiques</h2>
        <div style="overflow-x: auto;"> <table class="stats-table">
                <thead>
                    <tr>
                        <th>Force</th>
                        <th>Endurance</th>
                        <th>Agilité</th>
                        <th>Dextérité</th>
                        <th>Perception</th>
                        <th>Mental</th>
                        <th>Intelligence</th>
                        <th>Sociabilité</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" id="force" class="save-field" value="10"></td>
                        <td><input type="number" id="endurance" class="save-field" value="10"></td>
                        <td><input type="number" id="agilite" class="save-field" value="10"></td>
                        <td><input type="number" id="dexterite" class="save-field" value="10"></td>
                        <td><input type="number" id="perception" class="save-field" value="10"></td>
                        <td><input type="number" id="mental" class="save-field" value="10"></td>
                        <td><input type="number" id="intelligence" class="save-field" value="10"></td>
                        <td><input type="number" id="sociabilite" class="save-field" value="10"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 class="section-title">Équipement de Combat</h2>
        <div class="input-group">
            <label>Arme</label>
            <input type="text" id="armePortee" class="save-field" placeholder="Nom de l'arme...">
        </div>

        <h2 class="section-title">Compétences, talents et sorts</h2>
        
        <h3>Compétences</h3>
        <table class="dynamic-table"><tbody id="bodyCompetences"></tbody></table>
        <button class="btn-add" onclick="addRow('bodyCompetences', 2)">+ Ajouter une compétence</button>

        <h3>Talents</h3>
        <table class="dynamic-table"><tbody id="bodyTalents"></tbody></table>
        <button class="btn-add" onclick="addRow('bodyTalents', 2)">+ Ajouter un talent</button>

        <h3>Sorts</h3>
        <table class="dynamic-table">
            <thead><tr><th>Rang</th><th>Nom</th><th>Description</th><th></th></tr></thead>
            <tbody id="bodySorts"></tbody>
        </table>
        <button class="btn-add" onclick="addRow('bodySorts', 3)">+ Ajouter un sort</button>

        <h2 class="section-title">Inventaire</h2>
        <div class="money-section">
            <label><strong>Fortune (Noz) :</strong></label>
            <input type="number" id="argentNoz" class="save-field" style="width: 120px;">
        </div>
        <table class="dynamic-table">
            <thead><tr><th>Objet</th><th>Description</th><th>Qté</th><th></th></tr></thead>
            <tbody id="bodyInventaire"></tbody>
        </table>
        <button class="btn-add" onclick="addRow('bodyInventaire', 3)">+ Ajouter un objet</button>

        <h2 class="section-title">Histoire du Personnage</h2>
        <textarea id="histoirePerso" class="save-field" style="min-height: 250px;"></textarea>

        <p id="statut">Synchronisation...</p>
    </div>
</main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
      const firebaseConfig = {
        apiKey: "AIzaSyAhl7MuvCy54F4Qt27mtlVAqmCu4Bg-KCE",
        authDomain: "the-hope-heritage.firebaseapp.com",
        projectId: "the-hope-heritage",
        storageBucket: "the-hope-heritage.firebasestorage.app",
        messagingSenderId: "472185106488",
        appId: "1:472185106488:web:496f37e901690987f536cd"
      };
    
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
    
      const urlParams = new URLSearchParams(window.location.search);
      let joueurID = urlParams.get('id') || prompt("Entrez votre nom de personnage :");
      if (!joueurID) joueurID = "Anonyme";
      document.getElementById('displayID').innerText = joueurID;
    
      const persoRef = doc(db, "personnages", joueurID);
    
      // --- FONCTIONS DES TABLEAUX (Correction ici) ---
      
      // On attache la fonction à "window" pour que le "onclick" du HTML la voie
      window.addRow = function(tableId, cols) {
        const body = document.getElementById(tableId);
        const row = body.insertRow();
        for (let i = 0; i < cols; i++) {
          let cell = row.insertCell(i);
          cell.innerHTML = `<input type="text" class="table-input" placeholder="...">`;
          // Sauvegarde auto quand on écrit dans la nouvelle ligne
          cell.querySelector('input').addEventListener('input', window.sauvegarder);
        }
        let actionCell = row.insertCell(cols);
        actionCell.innerHTML = `<button class="btn-remove" onclick="this.parentElement.parentElement.remove(); window.sauvegarder();">X</button>`;
      };
    
      const getTableData = (tableBodyId) => {
        const rows = document.getElementById(tableBodyId).rows;
        return Array.from(rows).map(row => {
          return Array.from(row.cells)
            .slice(0, -1) // On ignore la cellule du bouton X
            .map(cell => cell.querySelector('input').value);
        });
      };
    
      const setTableData = (tableBodyId, data, cols) => {
        const body = document.getElementById(tableBodyId);
        body.innerHTML = ""; 
        if (!data) return;
        data.forEach(rowData => {
          const row = body.insertRow();
          rowData.forEach((val, i) => {
            let cell = row.insertCell(i);
            cell.innerHTML = `<input type="text" class="table-input" value="${val}">`;
            cell.querySelector('input').addEventListener('input', window.sauvegarder);
          });
          let actionCell = row.insertCell(rowData.length);
          actionCell.innerHTML = `<button class="btn-remove" onclick="this.parentElement.parentElement.remove(); window.sauvegarder();">X</button>`;
        });
      };
    
      // --- SAUVEGARDE ---
      window.sauvegarder = function() {
        const data = {};
        // Champs classiques
        document.querySelectorAll('.save-field').forEach(el => {
          data[el.id] = el.type === "number" ? parseInt(el.value) || 0 : el.value;
        });
        // Données des tableaux
        data.compData = getTableData('bodyCompetences');
        data.talentData = getTableData('bodyTalents');
        data.sortData = getTableData('bodySorts');
        data.invData = getTableData('bodyInventaire');
    
        setDoc(persoRef, data, { merge: true });
      };
    
      // --- CHARGEMENT ---
      onSnapshot(persoRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          // On ne met à jour que si l'utilisateur n'est pas en train d'écrire
          if (!document.activeElement.classList.contains('table-input') && 
              !document.activeElement.classList.contains('save-field')) {
            
            document.querySelectorAll('.save-field').forEach(el => {
              el.value = data[el.id] || (el.type === "number" ? 0 : "");
            });
    
            setTableData('bodyCompetences', data.compData, 2);
            setTableData('bodyTalents', data.talentData, 2);
            setTableData('bodySorts', data.sortData, 3);
            setTableData('bodyInventaire', data.invData, 3);
          }
          document.getElementById("statut").innerText = "Connecté : " + joueurID;
        }
      });
    
      // Écouteurs sur les champs fixes
      document.querySelectorAll('.save-field').forEach(el => {
        el.addEventListener('input', window.sauvegarder);
      });
    </script>
</body>
</html>
